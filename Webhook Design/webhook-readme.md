# Webhook design

## Components and flow

### Webhook controller

- The Webhook Controller processes events generated by the platform and determines which webhook endpoints to notify.
- It constructs tasks for webhook delivery based on event details and metadata.
- Input payloads by client

```
{
  "eventId": "evt_12345",
  "eventType": "OrderPlaced",
  "eventTimestamp": "2024-11-20T12:00:00Z",
  "data": {
    "orderId": "order_98765",
    "userId": "user_54321",
    "orderAmount": 100.50,
    "orderCurrency": "USD"
  }
}

```

- Metdata fetched for this event type from database/ cache

```
[
  {
    "subscriberId": "sub_001",
    "endpoint": "https://example.com/webhook1",
    "headers": {
      "Authorization": "Bearer token1"
    }
  },
  {
    "subscriberId": "sub_002",
    "endpoint": "https://example.com/webhook2",
    "headers": {
      "Authorization": "Bearer token2"
    }
  },
  {
    "subscriberId": "sub_003",
    "endpoint": "https://example.com/webhook3",
    "headers": {
      "Authorization": "Bearer token3"
    }
  }
  // ... up to 100 subscribers
]
```

- Output payload per client
```
{
  "eventId": "evt_12345",
  "eventType": "OrderPlaced",
  "subscriberId": "sub_001",
  "endpoint": "https://example.com/webhook1",
  "headers": {
    "Authorization": "Bearer token1"
  },
  "payload": {
    "orderId": "order_98765",
    "userId": "user_54321",
    "orderAmount": 100.50,
    "orderCurrency": "USD"
  }
}

```

- event metadata for storing statuses
```
{
  "eventId": "evt_12345",
  "subscriberId": "sub_001",
  "status": "pending",
  "lastAttemptTimestamp": "2024-11-20T12:05:00Z",
  "retryCount": 0
}

```

### Webhook Worker

- The webhook worker will consume the events from queue which are sent by webhook conroller

- Webhook worker will update the delivery log
```
{
  "eventId": "evt_12345",
  "subscriberId": "sub_001",
  "status": "delivered",
  "lastAttemptTimestamp": "2024-11-20T12:05:00Z",
  "retryCount": 0
}

```
